<div class="explicacio esquema-modular">
	<style>
	.schema-frame {
		background: #fbfcff;
		padding: 24px;
		border-radius: 14px;
		margin-bottom: 24px;
		border: 1px solid #e7ebf2;
		box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
		transition: all 0.2s ease;
	}

	.schema-frame:hover {
		transform: translateY(-1px);
		box-shadow: 0 14px 28px rgba(15, 23, 42, 0.09);
	}

	.schema-toggle {
		cursor: pointer;
		font-weight: 600;
		margin-top: 12px;
		color: #1e4bd1;
		transition: all 0.2s ease;
	}

	.schema-toggle:hover {
		color: #163ea8;
	}

	.schema-content {
		display: none;
		margin-top: 10px;
		padding: 14px;
		background: #ffffff;
		border-left: 3px solid #1e4bd1;
		border-radius: 8px;
	}

	.diagram-viewer {
		display: flex;
		flex-direction: column;
		gap: 10px;
	}

	.diagram-container {
		width: 100%;
		height: 600px;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.diagram-controls {
		display: flex;
		gap: 8px;
		flex-wrap: wrap;
	}

	.diagram-controls button {
		border: 1px solid #cbd5e1;
		background: #f8fafc;
		color: #0f172a;
		font-size: 0.9rem;
		padding: 6px 10px;
		border-radius: 8px;
		cursor: pointer;
	}

	.diagram-controls button:hover {
		background: #eef2ff;
	}

	.diagram-stage {
		position: relative;
		width: 100%;
		height: 100%;
		min-height: 0;
		display: flex;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		background: #ffffff;
		border: 1px solid #dbe3ef;
		border-radius: 10px;
		cursor: grab;
		touch-action: none;
	}

	.diagram-stage.is-dragging {
		cursor: grabbing;
	}

	.diagram-stage img {
		max-width: 100%;
		max-height: 100%;
		object-fit: contain;
		display: block;
		user-select: none;
		-webkit-user-drag: none;
		transform-origin: 0 0;
		will-change: transform;
		transition: transform 0.08s ease-out;
	}

	.esquema-modular h2 {
		margin: 34px 0 16px;
	}

	.esquema-modular h3 {
		margin: 0 0 2px;
	}

	.esquema-modular h1 {
		margin: 0 0 20px;
	}
	</style>

	<h2>I. TEORIA GENERAL DEL SISTEMA DE FONTS</h2>
	<div class="schema-frame">
		<h3>1. Concepte de font del dret</h3>
		<div class="schema-toggle" onclick="toggleSection('p1-preguntes')">&gt; Preguntes</div>
		<div id="p1-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p1-diagrama')">&gt; Diagrama</div>
		<div id="p1-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p1-explicacio')">&gt; Explicació</div>
		<div id="p1-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>2. Fonts formals vs materials</h3>
		<div class="schema-toggle" onclick="toggleSection('p2-preguntes')">&gt; Preguntes</div>
		<div id="p2-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p2-diagrama')">&gt; Diagrama</div>
		<div id="p2-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p2-explicacio')">&gt; Explicació</div>
		<div id="p2-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>3. Sistema de fonts en l’Estat de dret</h3>
		<div class="schema-toggle" onclick="toggleSection('p3-preguntes')">&gt; Preguntes</div>
		<div id="p3-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p3-diagrama')">&gt; Diagrama</div>
		<div id="p3-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p3-explicacio')">&gt; Explicació</div>
		<div id="p3-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>4. Principis estructurals (legalitat, jerarquia normativa, competència, seguretat jurídica, interdicció arbitrarietat)</h3>
		<div class="schema-toggle" onclick="toggleSection('p4-preguntes')">&gt; Preguntes</div>
		<div id="p4-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p4-diagrama')">&gt; Diagrama</div>
		<div id="p4-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p4-explicacio')">&gt; Explicació</div>
		<div id="p4-explicacio" class="schema-content">En construcció</div>
	</div>

	<h2>II. ESTRUCTURA NORMATIVA</h2>
	<div class="schema-frame">
		<h3>5. Constitució com a norma suprema</h3>
		<div class="schema-toggle" onclick="toggleSection('p5-preguntes')">&gt; Preguntes</div>
		<div id="p5-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p5-diagrama')">&gt; Diagrama</div>
		<div id="p5-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p5-explicacio')">&gt; Explicació</div>
		<div id="p5-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>6. Bloc de constitucionalitat</h3>
		<div class="schema-toggle" onclick="toggleSection('p6-preguntes')">&gt; Preguntes</div>
		<div id="p6-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p6-diagrama')">&gt; Diagrama</div>
		<div id="p6-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p6-explicacio')">&gt; Explicació</div>
		<div id="p6-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>7. La llei com a font</h3>
		<div class="schema-toggle" onclick="toggleSection('p7-preguntes')">&gt; Preguntes</div>
		<div id="p7-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p7-diagrama')">&gt; Diagrama</div>
		<div id="p7-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p7-explicacio')">&gt; Explicació</div>
		<div id="p7-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>8. Normes amb rang de llei (decret llei i decret legislatiu)</h3>
		<div class="schema-toggle" onclick="toggleSection('p8-preguntes')">&gt; Preguntes</div>
		<div id="p8-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p8-diagrama')">&gt; Diagrama</div>
		<div id="p8-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p8-explicacio')">&gt; Explicació</div>
		<div id="p8-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>9. Reserva de llei</h3>
		<div class="schema-toggle" onclick="toggleSection('p9-preguntes')">&gt; Preguntes</div>
		<div id="p9-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p9-diagrama')">&gt; Diagrama</div>
		<div id="p9-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p9-explicacio')">&gt; Explicació</div>
		<div id="p9-explicacio" class="schema-content">En construcció</div>
	</div>

	<h2>III. POTESTAT REGLAMENTÀRIA</h2>
	<div class="schema-frame">
		<h3>10. Concepte de reglament</h3>
		<div class="schema-toggle" onclick="toggleSection('p10-preguntes')">&gt; Preguntes</div>
		<div id="p10-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p10-diagrama')">&gt; Diagrama</div>
		<div id="p10-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p10-explicacio')">&gt; Explicació</div>
		<div id="p10-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>11. Fonament constitucional de la potestat reglamentària</h3>
		<div class="schema-toggle" onclick="toggleSection('p11-preguntes')">&gt; Preguntes</div>
		<div id="p11-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p11-diagrama')">&gt; Diagrama</div>
		<div id="p11-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p11-explicacio')">&gt; Explicació</div>
		<div id="p11-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>12. Classes de reglaments</h3>
		<div class="schema-toggle" onclick="toggleSection('p12-preguntes')">&gt; Preguntes</div>
		<div id="p12-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p12-diagrama')">&gt; Diagrama</div>
		<div id="p12-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p12-explicacio')">&gt; Explicació</div>
		<div id="p12-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>13. Límits del reglament</h3>
		<div class="schema-toggle" onclick="toggleSection('p13-preguntes')">&gt; Preguntes</div>
		<div id="p13-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p13-diagrama')">&gt; Diagrama</div>
		<div id="p13-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p13-explicacio')">&gt; Explicació</div>
		<div id="p13-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>14. Control jurisdiccional dels reglaments</h3>
		<div class="schema-toggle" onclick="toggleSection('p14-preguntes')">&gt; Preguntes</div>
		<div id="p14-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p14-diagrama')">&gt; Diagrama</div>
		<div id="p14-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p14-explicacio')">&gt; Explicació</div>
		<div id="p14-explicacio" class="schema-content">En construcció</div>
	</div>

	<h2>IV. DRET DE LA UNIÓ EUROPEA</h2>
	<div class="schema-frame">
		<h3>15. Principi de primacia</h3>
		<div class="schema-toggle" onclick="toggleSection('p15-preguntes')">&gt; Preguntes</div>
		<div id="p15-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p15-diagrama')">&gt; Diagrama</div>
		<div id="p15-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p15-explicacio')">&gt; Explicació</div>
		<div id="p15-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>16. Efecte directe</h3>
		<div class="schema-toggle" onclick="toggleSection('p16-preguntes')">&gt; Preguntes</div>
		<div id="p16-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p16-diagrama')">&gt; Diagrama</div>
		<div id="p16-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p16-explicacio')">&gt; Explicació</div>
		<div id="p16-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>17. Tipologia de normes UE</h3>
		<div class="schema-toggle" onclick="toggleSection('p17-preguntes')">&gt; Preguntes</div>
		<div id="p17-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p17-diagrama')">&gt; Diagrama</div>
		<div id="p17-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p17-explicacio')">&gt; Explicació</div>
		<div id="p17-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>18. Incidència del dret UE en l’ordenament administratiu</h3>
		<div class="schema-toggle" onclick="toggleSection('p18-preguntes')">&gt; Preguntes</div>
		<div id="p18-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p18-diagrama')">&gt; Diagrama</div>
		<div id="p18-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p18-explicacio')">&gt; Explicació</div>
		<div id="p18-explicacio" class="schema-content">En construcció</div>
	</div>

	<h2>V. FONTS SUPLETÒRIES</h2>
	<div class="schema-frame">
		<h3>19. Costum</h3>
		<div class="schema-toggle" onclick="toggleSection('p19-preguntes')">&gt; Preguntes</div>
		<div id="p19-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p19-diagrama')">&gt; Diagrama</div>
		<div id="p19-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p19-explicacio')">&gt; Explicació</div>
		<div id="p19-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>20. Principis generals del dret</h3>
		<div class="schema-toggle" onclick="toggleSection('p20-preguntes')">&gt; Preguntes</div>
		<div id="p20-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p20-diagrama')">&gt; Diagrama</div>
		<div id="p20-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p20-explicacio')">&gt; Explicació</div>
		<div id="p20-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>21. Equitat</h3>
		<div class="schema-toggle" onclick="toggleSection('p21-preguntes')">&gt; Preguntes</div>
		<div id="p21-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p21-diagrama')">&gt; Diagrama</div>
		<div id="p21-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p21-explicacio')">&gt; Explicació</div>
		<div id="p21-explicacio" class="schema-content">En construcció</div>
	</div>

	<h2>VI. JURISPRUDÈNCIA</h2>
	<div class="schema-frame">
		<h3>22. Jurisprudència com a criteri interpretatiu</h3>
		<div class="schema-toggle" onclick="toggleSection('p22-preguntes')">&gt; Preguntes</div>
		<div id="p22-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p22-diagrama')">&gt; Diagrama</div>
		<div id="p22-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p22-explicacio')">&gt; Explicació</div>
		<div id="p22-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>23. Funció del Tribunal Suprem</h3>
		<div class="schema-toggle" onclick="toggleSection('p23-preguntes')">&gt; Preguntes</div>
		<div id="p23-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p23-diagrama')">&gt; Diagrama</div>
		<div id="p23-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p23-explicacio')">&gt; Explicació</div>
		<div id="p23-explicacio" class="schema-content">En construcció</div>
	</div>
	<div class="schema-frame">
		<h3>24. Funció del Tribunal Constitucional</h3>
		<div class="schema-toggle" onclick="toggleSection('p24-preguntes')">&gt; Preguntes</div>
		<div id="p24-preguntes" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p24-diagrama')">&gt; Diagrama</div>
		<div id="p24-diagrama" class="schema-content">En construcció</div>
		<div class="schema-toggle" onclick="toggleSection('p24-explicacio')">&gt; Explicació</div>
		<div id="p24-explicacio" class="schema-content">En construcció</div>
	</div>

	<script>
	function getCurrentBlocTema() {
		const match = window.location.pathname.match(/\/bloc\/([^/]+)\/([^/]+)/);
		if (match) {
			return { blocId: match[1], temaId: match[2] };
		}

		return { blocId: 'bloc-2', temaId: 'tema-04' };
	}

	function executeEmbeddedScripts(container) {
		container.querySelectorAll('script').forEach((oldScript) => {
			const newScript = document.createElement('script');
			if (oldScript.src) {
				newScript.src = oldScript.src;
			} else {
				newScript.textContent = oldScript.textContent;
			}
			Array.from(oldScript.attributes).forEach((attribute) => {
				if (attribute.name !== 'src') {
					newScript.setAttribute(attribute.name, attribute.value);
				}
			});
			oldScript.parentNode.replaceChild(newScript, oldScript);
		});
	}

	async function loadExplicacio(pointNumber, container) {
		if (!container || container.dataset.loaded === 'true') return;

		const { blocId, temaId } = getCurrentBlocTema();
		const htmlPath = `/content/${blocId}/${temaId}/esquemes/${pointNumber}.html`;

		try {
			const response = await fetch(htmlPath);
			if (!response.ok) throw new Error('Not found');
			const html = await response.text();
			container.innerHTML = html;
			container.dataset.loaded = 'true';
		} catch {
			container.innerHTML = 'En construcció';
			container.dataset.loaded = 'true';
		}
	}

	async function loadPreguntes(container) {
		if (!container || container.dataset.loaded === 'true') return;

		const { blocId, temaId } = getCurrentBlocTema();
		const htmlPath = `/content/${blocId}/${temaId}/preguntes/1.html`;

		try {
			const response = await fetch(htmlPath);
			if (!response.ok) throw new Error('Not found');
			const html = await response.text();
			container.innerHTML = html;
			executeEmbeddedScripts(container);
			container.dataset.loaded = 'true';
		} catch {
			container.innerHTML = 'En construcció';
			container.dataset.loaded = 'true';
		}
	}

	function setupDiagramViewer(container, imageSrc, altText) {
		container.innerHTML = `
			<div class="diagram-viewer">
				<div class="diagram-controls">
					<button type="button" data-action="zoom-in">+</button>
					<button type="button" data-action="zoom-out">-</button>
					<button type="button" data-action="reset">Reset</button>
					<button type="button" data-action="fit">Fit</button>
					<button type="button" data-action="open">Open</button>
				</div>
				<div class="diagram-container">
					<div class="diagram-stage" data-role="viewport">
						<img src="${imageSrc}" alt="${altText}" />
					</div>
				</div>
			</div>
		`;

		const viewer = container.querySelector('.diagram-viewer');
		const stage = viewer?.querySelector('[data-role="viewport"]');
		const image = viewer?.querySelector('img');
		if (!viewer || !stage || !image) {
			container.innerHTML = 'En construcció';
			return;
		}

		image.addEventListener('error', () => {
			container.innerHTML = 'En construcció';
		});

		let zoom = 1;
		let offset = { x: 0, y: 0 };
		const minZoom = 1;
		const maxZoom = 4;
		let isDragging = false;
		let dragStart = { x: 0, y: 0 };
		let velocity = { x: 0, y: 0 };
		let inertiaFrame = null;

		const clamp = (value, min, max) => Math.min(max, Math.max(min, value));

		const stopInertia = () => {
			if (inertiaFrame) {
				cancelAnimationFrame(inertiaFrame);
				inertiaFrame = null;
			}
		};

		const clampOffset = (x, y, currentZoom) => {
			const containerRect = stage.getBoundingClientRect();
			const imageWidth = image.clientWidth;
			const imageHeight = image.clientHeight;
			if (!containerRect.width || !containerRect.height || !imageWidth || !imageHeight) {
				return { x, y };
			}

			const scaledWidth = imageWidth * currentZoom;
			const scaledHeight = imageHeight * currentZoom;

			const maxShiftX = Math.max(0, (scaledWidth - containerRect.width) / 2);
			const maxShiftY = Math.max(0, (scaledHeight - containerRect.height) / 2);

			return {
				x: clamp(x, -maxShiftX, maxShiftX),
				y: clamp(y, -maxShiftY, maxShiftY),
			};
		};

		const render = () => {
			image.style.transform = `translate(${offset.x}px, ${offset.y}px) scale(${zoom})`;
		};

		const applyOffset = (nextX, nextY) => {
			offset = clampOffset(nextX, nextY, zoom);
			render();
		};

		const handleFit = () => {
			stopInertia();
			zoom = 1;
			offset = { x: 0, y: 0 };
			render();
		};

		const scheduleFit = () => {
			window.requestAnimationFrame(() => {
				window.setTimeout(() => {
					handleFit();
				}, 0);
			});
		};

		image.addEventListener('load', scheduleFit, { once: true });
		if (image.complete) {
			scheduleFit();
		}

		viewer.querySelector('[data-action="zoom-in"]').addEventListener('click', () => {
			stopInertia();
			zoom = clamp(zoom * 1.2, minZoom, maxZoom);
			applyOffset(offset.x, offset.y);
		});

		viewer.querySelector('[data-action="zoom-out"]').addEventListener('click', () => {
			stopInertia();
			zoom = clamp(zoom / 1.2, minZoom, maxZoom);
			applyOffset(offset.x, offset.y);
		});

		viewer.querySelector('[data-action="reset"]').addEventListener('click', scheduleFit);

		viewer.querySelector('[data-action="fit"]').addEventListener('click', scheduleFit);

		viewer.querySelector('[data-action="open"]').addEventListener('click', () => {
			const { blocId, temaId } = getCurrentBlocTema();
			const pointFromPath = imageSrc.match(/\/(\d+)\.png$/)?.[1];
			if (!pointFromPath) return;
			window.location.assign(`/diagram-viewer/${blocId}/${temaId}/${pointFromPath}`);
		});

		const onMouseDown = (event) => {
			stopInertia();
			isDragging = true;
			dragStart = {
				x: event.clientX - offset.x,
				y: event.clientY - offset.y,
			};
			velocity = { x: 0, y: 0 };
			stage.classList.add('is-dragging');
		};

		const onMouseMove = (event) => {
			if (!isDragging) return;
			const nextX = event.clientX - dragStart.x;
			const nextY = event.clientY - dragStart.y;
			const clamped = clampOffset(nextX, nextY, zoom);
			velocity = {
				x: clamped.x - offset.x,
				y: clamped.y - offset.y,
			};
			offset = clamped;
			render();
		};

		const onMouseUp = () => {
			if (!isDragging) return;
			isDragging = false;
			stage.classList.remove('is-dragging');

			const friction = 0.95;
			const animate = () => {
				velocity.x *= friction;
				velocity.y *= friction;

				if (Math.abs(velocity.x) < 0.1 && Math.abs(velocity.y) < 0.1) {
					stopInertia();
					return;
				}

				const next = clampOffset(offset.x + velocity.x, offset.y + velocity.y, zoom);
				if (next.x === offset.x) {
					velocity.x = 0;
				}
				if (next.y === offset.y) {
					velocity.y = 0;
				}

				offset = next;
				render();
				inertiaFrame = requestAnimationFrame(animate);
			};

			inertiaFrame = requestAnimationFrame(animate);
		};

		const onWheel = (event) => {
			event.preventDefault();
			stopInertia();
			const zoomIntensity = 0.1;
			const nextZoom = clamp(zoom - event.deltaY * zoomIntensity * 0.01, minZoom, maxZoom);
			if (nextZoom === zoom) return;
			zoom = nextZoom;
			applyOffset(offset.x, offset.y);
		};

		const onResize = () => {
			applyOffset(offset.x, offset.y);
		};

		const resizeObserver = new ResizeObserver(() => {
			scheduleFit();
		});

		stage.addEventListener('mousedown', onMouseDown);
		stage.addEventListener('wheel', onWheel, { passive: false });
		window.addEventListener('mousemove', onMouseMove);
		window.addEventListener('mouseup', onMouseUp);
		window.addEventListener('resize', onResize);
		resizeObserver.observe(stage);

		container.__fitDiagram = scheduleFit;

		container.__destroyDiagramViewer = () => {
			stopInertia();
			stage.removeEventListener('mousedown', onMouseDown);
			stage.removeEventListener('wheel', onWheel);
			window.removeEventListener('mousemove', onMouseMove);
			window.removeEventListener('mouseup', onMouseUp);
			window.removeEventListener('resize', onResize);
			resizeObserver.disconnect();
		};
	}

	function imageExists(src) {
		return new Promise((resolve) => {
			const image = new Image();
			image.onload = () => resolve(true);
			image.onerror = () => resolve(false);
			image.src = src;
		});
	}

	async function loadDiagrama(pointNumber, container) {
		if (!container || container.dataset.loaded === 'true') return;

		const { blocId, temaId } = getCurrentBlocTema();
		const normalizedPoint = String(pointNumber || '').trim();
		if (!/^\d+$/.test(normalizedPoint)) {
			container.innerHTML = 'En construcció';
			container.dataset.loaded = 'true';
			return;
		}
		const imageSrc = `/content/${blocId}/${temaId}/diagrama/${normalizedPoint}.png`;

		const exists = await imageExists(imageSrc);
		if (!exists) {
			container.innerHTML = 'En construcció';
			container.dataset.loaded = 'true';
			return;
		}

		setupDiagramViewer(container, imageSrc, `Diagrama punt ${pointNumber}`);
		container.dataset.loaded = 'true';
	}

	function toggleSection(id) {
		const el = document.getElementById(id);
		if (!el) return;
		const willOpen = el.style.display !== 'block';

		const preguntesMatch = id.match(/^p(\d+)-preguntes$/);
		if (preguntesMatch && willOpen) {
			loadPreguntes(el);
		}

		const diagramaMatch = id.match(/^p(\d+)-diagrama$/);
		if (diagramaMatch && willOpen) {
			loadDiagrama(diagramaMatch[1], el);
		}

		const explicacioMatch = id.match(/^p(\d+)-explicacio$/);
		if (explicacioMatch && willOpen) {
			loadExplicacio(explicacioMatch[1], el);
		}

		if (!willOpen) {
			if (diagramaMatch && typeof el.__destroyDiagramViewer === 'function') {
				el.__destroyDiagramViewer();
				delete el.__destroyDiagramViewer;
			}
			el.style.display = "none";
		} else {
			el.style.display = "block";
			if (diagramaMatch) {
				window.requestAnimationFrame(() => {
					window.setTimeout(() => {
						if (typeof el.__fitDiagram === 'function') {
							el.__fitDiagram();
						}
					}, 0);
				});
			}
		}
	}

	(function initEsquemesPointAccordion() {
		const styleId = 'esquema-point-accordion-style';
		if (!document.getElementById(styleId)) {
			const style = document.createElement('style');
			style.id = styleId;
			style.textContent = `
			.point-toggle {
				width: 100%;
				display: flex;
				align-items: center;
				gap: 10px;
				margin: 0;
				padding: 0;
				background: transparent;
				border: 0;
				cursor: pointer;
				text-align: left;
			}
			.point-arrow {
				color: #1e4bd1;
				font-size: 0.92rem;
				transition: transform 0.2s ease;
			}
			.point-toggle.open .point-arrow {
				transform: rotate(90deg);
			}
			.point-title {
				font-size: 1.02rem;
				font-weight: 700;
				color: #0f172a;
				line-height: 1.35;
			}
			.point-content {
				display: none;
				margin-top: 10px;
			}
			`;
			document.head.appendChild(style);
		}

		const frames = document.querySelectorAll('.esquema-modular .frame, .esquema-modular .schema-frame');
		frames.forEach((frame) => {
			if (frame.dataset.pointAccordion === 'true') return;

			const title = frame.querySelector('h3');
			if (!title) return;

			const button = document.createElement('button');
			button.type = 'button';
			button.className = 'point-toggle';
			button.setAttribute('aria-expanded', 'false');
			button.innerHTML = `<span class="point-arrow">▸</span><span class="point-title">${title.textContent}</span>`;

			title.replaceWith(button);

			const body = document.createElement('div');
			body.className = 'point-content';
			while (button.nextSibling) {
				body.appendChild(button.nextSibling);
			}
			frame.appendChild(body);

			button.addEventListener('click', () => {
				const isOpen = button.classList.contains('open');

				document.querySelectorAll('.esquema-modular .point-toggle.open').forEach((opened) => {
					if (opened !== button) {
						opened.classList.remove('open');
						opened.setAttribute('aria-expanded', 'false');
						const openedBody = opened.parentElement.querySelector('.point-content');
						if (openedBody) openedBody.style.display = 'none';
					}
				});

				if (isOpen) {
					button.classList.remove('open');
					button.setAttribute('aria-expanded', 'false');
					body.style.display = 'none';
				} else {
					button.classList.add('open');
					button.setAttribute('aria-expanded', 'true');
					body.style.display = 'block';
				}
			});

			frame.dataset.pointAccordion = 'true';
		});
	})();
	</script>
</div>
